version: '3.8'

# Base Infrastructure Services
# These services are shared across all clients

services:
  # Traefik Reverse Proxy - Shared across all clients
  traefik:
    image: traefik:v3.0
    container_name: traefik
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"  # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - ./ssl:/ssl:ro
      - ./logs/traefik:/var/log/traefik
    environment:
      - TRAEFIK_LOG_LEVEL=INFO
    restart: unless-stopped
    networks:
      - web
      - internal
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
        reservations:
          memory: 64M
          cpus: '0.1'
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${BASE_DOMAIN}`)"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"

  # Portainer for container management
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    restart: unless-stopped
    networks:
      - web
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
        reservations:
          memory: 64M
          cpus: '0.1'
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`admin.${BASE_DOMAIN}`)"
      - "traefik.http.routers.portainer.tls=true"
      - "traefik.http.routers.portainer.tls.certresolver=letsencrypt"
      - "traefik.http.services.portainer.loadbalancer.server.port=9000"

  # Watchtower for auto-updates
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=3600
      - WATCHTOWER_NOTIFICATIONS=slack
      - WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL=${SLACK_WEBHOOK_URL:-}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 64M
          cpus: '0.1'
        reservations:
          memory: 32M
          cpus: '0.05'

  # Shared MariaDB Database - All clients use this
  mariadb-shared:
    image: mariadb:10.11
    container_name: mariadb-shared
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: wordpress
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mariadb_shared_data:/var/lib/mysql
      - ./mysql/my.cnf:/etc/mysql/conf.d/my.cnf:ro
      - ./scripts/create-client-db.sh:/docker-entrypoint-initdb.d/create-client-db.sh:ro
    restart: unless-stopped
    networks:
      - internal
    command: --innodb-buffer-pool-size=512M --innodb-log-file-size=64M --max-connections=100 --innodb-flush-log-at-trx-commit=2 --innodb-flush-method=O_DIRECT
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.3'

  # Shared Redis Cache - All clients use this
  redis-shared:
    image: redis:7-alpine
    container_name: redis-shared
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru --save 900 1 --save 300 10
    volumes:
      - redis_shared_data:/data
    restart: unless-stopped
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 320M
          cpus: '0.2'
        reservations:
          memory: 256M
          cpus: '0.1'

  # Shared PHP-FPM Service - All clients use this
  php-fpm-shared:
    build:
      context: ./php-fpm
      dockerfile: Dockerfile
    container_name: php-fpm-shared
    volumes:
      - ./wordpress:/shared-wordpress:ro
      - ./clients:/var/www/clients:rw
      - ./scripts/php-fpm-pool.conf:/usr/local/etc/php-fpm.d/www.conf:ro
      - ./scripts/init-wordpress.sh:/init-wordpress.sh:ro
    environment:
      - PHP_MEMORY_LIMIT=256M
      - PHP_MAX_EXECUTION_TIME=300
      - PHP_UPLOAD_MAX_FILESIZE=64M
      - PHP_POST_MAX_SIZE=64M
    restart: unless-stopped
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.3'

  # Shared Nginx Router - Routes domains to shared PHP service
  nginx-router:
    image: nginx:alpine
    container_name: nginx-router
    volumes:
      - ./wordpress:/shared-wordpress:ro
      - ./clients:/var/www/clients:ro
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./scripts/update-nginx-config.sh:/update-nginx-config.sh:ro
    restart: unless-stopped
    networks:
      - web
      - internal
    depends_on:
      - php-fpm-shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.nginx-router.rule=HostRegexp(`{domain:[a-zA-Z0-9.-]+}`)"
      - "traefik.http.routers.nginx-router.entrypoints=web"
      - "traefik.http.routers.nginx-router.tls=true"
      - "traefik.http.routers.nginx-router.tls.certresolver=letsencrypt"
      - "traefik.http.services.nginx-router.loadbalancer.server.port=80"
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.2'
        reservations:
          memory: 64M
          cpus: '0.1'

volumes:
  portainer_data:
  mariadb_shared_data:
  redis_shared_data:

networks:
  web:
    driver: bridge
  internal:
    driver: bridge